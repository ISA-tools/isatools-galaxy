<?xml version='1.0' encoding='UTF-8'?>
<tool id="ISAslicer2_data_filter" name="ISAslicer2_data_filter" version="@TOOL_VERSION@">
    <description>Filters data files based on ISAslicer2 slices</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <stdio>
        <exit_code range="1:" level="fatal"/>
    </stdio>
    <command><![CDATA[
#set $output_path = "study_dir/"

mkdir '${output_path}' &&
'$__tool_directory__/isaslicer.py' filter-data '${isatab_input.extra_files_path}' ${output_path} --slice='${slice_input}' --filename_filter='$filename_filter'
    ]]></command>
    <inputs>
        <param name="isatab_input" type="data" format="isa-tab" label="ISA-Tab"  help="An ISA-Tab datatype history item."/>
        <param name="slice_input" type="data" format="json" label="Sliced data list"  help="JSON list of samples and data generated by ISAslicer2."/>
        <param name="filename_filter" type="text" label="Filter using shell-style wildcards." value="*.*" help="e.g. *.mzML, *.nmrML, a_*.txt, *.maf etc."/>
    </inputs>
    <outputs>
        <collection name="all_files" type="list" label="Slice of data files">
            <discover_datasets pattern="__designation__" directory="study_dir"/>
        </collection>
        <data name="log_file" format="txt" label="Data Filter Log" from_work_dir="cli.log"/>
    </outputs>
    <tests>
        <test>
            <param name="isatab_input" value="MTBLS36.zip" ftype="isa-tab"/>
            <param name="slice_input" value="query_results.json" ftype="json"/>
            <param name="filename_filter" value="m_esb tomato_metabolite profiling_mass spectrometry*.tsv"/>
            <output_collection name="all_files" type="list">
                <element name="m_esb tomato_metabolite profiling_mass spectrometry-1_v2_maf.tsv" file="m_esb tomato_metabolite profiling_mass spectrometry-1_v2_maf.tsv" />
                <element name="m_esb tomato_metabolite profiling_mass spectrometry_v2_maf.tsv" file="m_esb tomato_metabolite profiling_mass spectrometry_v2_maf.tsv" />
            </output_collection>
            <output name="log_file" file="cli.log" compare="contains" />
        </test>
    </tests>
    <help>
<!-- @@@BEGIN_RST@@@ -->
======================
ISAslicer2 Data Filter
======================

This tool returns a dataset collection based on an input ISA-Tab datatype
history item and a list of samples and data files generated by ISAslicer2.

Note that this tool relies on the input ISA-Tab dataset containing all of the
relevant data files, and the dataset collection generated links back to these
files rather than duplicating the files.

-----
Input
-----
ISA-Tab datatype history item
=============================
If the input source is an ISA-Tab history item, select from existing data
history items. ISA-Tab items can be created by using the Metabolights
downloader or the ISA-Tab metadata creation tools.

Sliced list of samples and data
===============================
A JSON list of samples and data files generated by using the ISAslicer2 tool.
If no list is provided, the tool will attempt to extract all files. Data files
that do not match the ISA-Tab datatype history item's contents will not be
extracted.

Filename filter
===============
A shell-style wildcard, for example for mzML files use \*.mzML.

------
Output
------

Dataset collection of sliced data files
=======================================
A subset of data files as informed by the sliced data JSON applied to the
provided ISA-Tab datatype history item.

<!-- @@@END_RST@@@ -->
    </help>
    <citations>
        <citation type="doi">10.5281/zenodo.163640</citation>
        <citation type="doi">10.1038/ng.1054</citation>
    </citations>
</tool>
